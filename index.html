<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema Financeiro Avan√ßado</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
    :root{
      --bg:#f0f2f5; --card:#fff; --accent:#2ecc71; --danger:#e74c3c; --primary:#3498db;
      --text:#333; --text-muted:#555; --thead:#2c3e50; --stripe:#f2f2f2; --shadow:0 4px 15px rgba(0,0,0,0.1);
    }
    /* Dark mode vars */
    .dark{
      --bg:#0f141a; --card:#121a22; --accent:#23c36b; --danger:#ef4444; --primary:#3b82f6;
      --text:#e5e7eb; --text-muted:#9ca3af; --thead:#0b1117; --stripe:#0c1722; --shadow:0 6px 20px rgba(0,0,0,0.35);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:'Roboto',sans-serif; background:var(--bg); color:var(--text);}
    header{
      background: linear-gradient(90deg,#0f2027,#203a43,#2c5364);
      color:#fff; padding:16px 20px; display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    header h1{font-size:22px; margin:0; font-weight:700;}
    .header-actions{display:flex; flex-wrap:wrap; gap:8px}
    .btn{
      background:var(--primary); color:#fff; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; box-shadow:var(--shadow);
      display:inline-flex; align-items:center; gap:8px; font-weight:700
    }
    .btn.secondary{ background:#64748b }
    .btn.accent{ background:var(--accent) }
    .btn.danger{ background:var(--danger) }
    .btn:hover{ filter:brightness(.95) }
    .container{ max-width:1200px; margin:auto; padding:20px; }

    .dashboard{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:20px; }
    .card{ background:var(--card); border-radius:14px; box-shadow:var(--shadow); padding:18px; transition: transform .2s; text-align:center; }
    .card:hover{ transform: translateY(-4px) }
    .card h3{ margin:0 0 8px; font-size:14px; color:var(--text-muted) }
    .card p{ font-size:22px; font-weight:800; margin:0 }

    .transaction-form{
      background:var(--card); padding:16px; border-radius:14px; margin-bottom:12px; box-shadow:var(--shadow);
      display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      align-items:end;
    }
    .transaction-form input, .transaction-form select, .transaction-form button{
      padding:10px; border-radius:10px; border:1px solid #2b2f3680; background:transparent; color:var(--text)
    }
    .transaction-form input[type="number"]{ text-align:right }
    .transaction-form button{ background:var(--accent); color:white; border:none; cursor:pointer; transition:.2s; font-weight:700 }
    .transaction-form button:hover{ filter:brightness(.95) }

    .row-actions{ display:flex; flex-wrap:wrap; gap:10px; margin:14px 0 6px }
    .filters{ display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 18px }
    .filters input, .filters select, .filters button{ padding:8px; border-radius:10px; border:1px solid #2b2f3680; background:transparent; color:var(--text) }
    .filters .grow{ flex:1 1 220px }

    table{ width:100%; border-collapse:collapse; background:var(--card); border-radius:14px; overflow:hidden; box-shadow:var(--shadow); margin-bottom:16px }
    th, td{ padding:12px; text-align:left }
    th{ background:var(--thead); color:white; font-weight:800 }
    tr:nth-child(even){ background:var(--stripe) }
    .income{ color:#22c55e; font-weight:800 }
    .expense{ color:#ef4444; font-weight:800 }
    .status-select{ border:none; font-weight:700; width:100%; background:transparent; cursor:pointer; color:inherit }
    .export-btn, #toggle-charts{ background:var(--primary); color:white; padding:10px 15px; border:none; border-radius:10px; cursor:pointer; margin-bottom:12px; box-shadow:var(--shadow) }
    .export-btn:hover, #toggle-charts:hover{ filter:brightness(.93) }
    .charts-row{ display:flex; flex-wrap:wrap; gap:20px; justify-content:center; margin-bottom:24px }
    .chart-box{ background:var(--card); border-radius:14px; box-shadow:var(--shadow); padding:14px; flex:1 1 360px; min-width:300px; max-width:520px }
    .chart-box canvas{ width:100% !important; height:300px !important }
    #monthly-chart{ max-height:320px !important; margin-bottom:20px; width:100% !important }
    tfoot td{ font-weight:800 }

    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800 }
    .pill.pago{ background:#16a34a1a; color:#22c55e; border:1px solid #22c55e50 }
    .pill.pendente{ background:#f59e0b1a; color:#f59e0b; border:1px solid #f59e0b50 }
    .pill.atrasado{ background:#ef44441a; color:#ef4444; border:1px solid #ef444450 }

    .hint{ font-size:12px; color:var(--text-muted); margin-top:-6px; margin-bottom:8px }
    @media (max-width:700px){ .transaction-form{ grid-template-columns:1fr 1fr } }
  </style>
</head>
<body>

<header>
  <h1>Sistema Financeiro</h1>
  <div class="header-actions">
    <button id="theme-toggle" class="btn secondary" title="Alternar tema (Dark/Light)">üåó Tema</button>
    <button id="toggle-charts" class="btn">üìà Mostrar Gr√°ficos</button>
    <button id="quick-report" class="btn accent">üßæ Relat√≥rio R√°pido (PDF)</button>
  </div>
</header>

<div class="container">

  <!-- Dashboard -->
  <div class="dashboard">
    <div class="card"><h3>Saldo Atual</h3><p id="balance">R$ 0,00</p></div>
    <div class="card"><h3>Total Receitas</h3><p id="total-income">R$ 0,00</p></div>
    <div class="card"><h3>Total Despesas</h3><p id="total-expense">R$ 0,00</p></div>
    <div class="card"><h3>Despesas Pendentes</h3><p id="pending-count">0</p></div>
  </div>

  <!-- Formul√°rio -->
  <div class="transaction-form" id="tx-form">
    <div>
      <input type="text" id="description" placeholder="Descri√ß√£o da D√≠vida" required />
      <div class="hint"></div>
    </div>
    <div>
      <input type="number" id="amount" placeholder="Valor da D√≠vida (R$)" required step="0.01" min="0" />
      <div class="hint"></div>
    </div>
    <div>
      <select id="type">
        <option value="income">Receita</option>
        <option value="expense">Despesa</option>
      </select>
      <div class="hint"></div>
    </div>
    <div>
      <select id="category">
        <option value="salario">Sal√°rio</option>
        <option value="alimentacao">Alimenta√ß√£o</option>
        <option value="transporte">Transporte</option>
        <option value="Farm√°cia">Farm√°cia</option>
        <option value="Empr√©stimo">Empr√©stimo</option>
        <option value="lazer">Lazer</option>
        <option value="outros">Outros</option>
      </select>
      <div class="hint"></div>
    </div>
    <div>
      <input type="date" id="date" required />
      <div class="hint"></div>
    </div>

    <!-- Recursos novos: Parcelas e Mensalidade (recorrente) -->
    <div>
      <input type="number" id="installments" placeholder="QTD Parcelas (opicional)" min="1" />
      <div class="hint"></div>
    </div>
    <div>
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="is-recurring" />
        Tornar mensal (recorrente)
      </label>
      <div class="hint"></div>
    </div>

    <button id="add-transaction">Registrar</button>
  </div>

  <!-- A√ß√µes e Filtros -->
  <div class="row-actions">
    <button class="btn" id="export-csv">Exportar CSV</button>
    <button class="btn" id="export-xlsx">Exportar Excel</button>
    <button class="btn" id="export-pdf">Exportar PDF</button>
    <button class="btn secondary" id="backup-local">Backup Local</button>
    <button class="btn secondary" id="restore-local">Restaurar Backup</button>
    <button class="btn danger" id="clear-all">Limpar Tudo</button>
  </div>

  <div class="filters">
    <input type="date" id="filter-start" />
    <input type="date" id="filter-end" />
    <select id="filter-type">
      <option value="all">Todos</option>
      <option value="income">Receitas</option>
      <option value="expense">Despesas</option>
    </select>
    <select id="filter-category">
      <option value="all">Todas Categorias</option>
      <option value="salario">Sal√°rio</option>
      <option value="alimentacao">Alimenta√ß√£o</option>
      <option value="transporte">Transporte</option>
      <option value="Farm√°cia">Farm√°cia</option>
      <option value="Empr√©stimo">Empr√©stimo</option>
      <option value="lazer">Lazer</option>
      <option value="outros">Outros</option>
    </select>
    <input id="search" class="grow" type="search" placeholder="Buscar por descri√ß√£o (tempo real)..." />
    <button id="apply-filters">Filtrar</button>
  </div>

  <!-- Gr√°ficos -->
  <div id="charts-container" class="charts-row" style="display:none;">
    <div class="chart-box"><canvas id="chart"></canvas></div>
    <div class="chart-box"><canvas id="status-chart"></canvas></div>
    <div class="chart-box"><canvas id="category-chart"></canvas></div>
  </div>

  <div class="chart-box" style="margin-bottom:18px;">
    <canvas id="monthly-chart"></canvas>
  </div>

  <!-- Tabela -->
  <table>
    <thead>
      <tr>
        <th>Descri√ß√£o</th><th>Valor</th><th>Tipo</th><th>Categoria</th><th>Data</th><th>Status</th><th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="transactions-table"></tbody>
    <tfoot>
      <tr>
        <td colspan="7" id="table-summary">0 itens ‚Ä¢ Receitas: R$ 0,00 ‚Ä¢ Despesas: R$ 0,00 ‚Ä¢ Saldo (vis√£o): R$ 0,00</td>
      </tr>
    </tfoot>
  </table>

</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Chart.js + plugin datalabels -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<!-- Exportadores -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>

<script>
/* ===================== Configura√ß√£o Firebase (mantida) ===================== */
const firebaseConfig = {
  apiKey: "AIzaSyDXDB6jbRy3o1eXcdXqmd8zrplDk1IezqM",
  authDomain: "sistema-financeiro-51295.firebaseapp.com",
  projectId: "sistema-financeiro-51295",
  storageBucket: "sistema-financeiro-51295.appspot.com",
  messagingSenderId: "340721821688",
  appId: "1:340721821688:web:77485712a056405f5f180d",
  measurementId: "G-X30NBWCY92",
  databaseURL: "https://sistema-financeiro-51295-default-rtdb.firebaseio.com"
};

let useFirebase = false;
let db = null;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  useFirebase = true;
  console.log('Firebase conectado');
} catch (e) {
  console.warn('Firebase n√£o dispon√≠vel ‚Äî usando LocalStorage.', e);
}

/* ===================== Elementos UI ===================== */
const balanceEl = document.getElementById('balance');
const totalIncomeEl = document.getElementById('total-income');
const totalExpenseEl = document.getElementById('total-expense');
const pendingCountEl = document.getElementById('pending-count');
const transactionsTable = document.getElementById('transactions-table');
const addTransactionBtn = document.getElementById('add-transaction');

const exportCsvBtn = document.getElementById('export-csv');
const exportXlsxBtn = document.getElementById('export-xlsx');
const exportPdfBtn = document.getElementById('export-pdf');
const quickReportBtn = document.getElementById('quick-report');

const toggleChartsBtn = document.getElementById('toggle-charts');
const chartsContainer = document.getElementById('charts-container');

const filterStart = document.getElementById('filter-start');
const filterEnd = document.getElementById('filter-end');
const filterType = document.getElementById('filter-type');
const filterCategory = document.getElementById('filter-category');
const searchInput = document.getElementById('search');

const themeToggle = document.getElementById('theme-toggle');
const tableSummary = document.getElementById('table-summary');

const backupBtn = document.getElementById('backup-local');
const restoreBtn = document.getElementById('restore-local');
const clearAllBtn = document.getElementById('clear-all');

/* ===================== Estado ===================== */
let transactions = [];
let editMode = false;
let editKey = null;

/* ===================== Utilit√°rios ===================== */
function formatCurrency(value) {
  const num = Number(value) || 0;
  return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(num);
}
function formatDateBR(dateStr) {
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
}
function addMonths(dateStr, n){
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  d.setMonth(d.getMonth() + n);
  const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function getStatus(t) {
  if (t.type === 'income') return 'Pago';
  if (t.status) return t.status;
  const today = new Date().toISOString().split('T')[0];
  return t.date < today ? 'Atrasado' : 'Pendente';
}
function toast(msg){
  // simples feedback visual
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.3);z-index:9999;font-weight:800';
  document.body.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .4s'; }, 1600);
  setTimeout(()=> el.remove(), 2200);
}

/* ===================== Persist√™ncia ===================== */
function loadTransactions() {
  if (useFirebase && db) {
    db.ref('transactions').on('value', snapshot => {
      const val = snapshot.val();
      transactions = val ? Object.entries(val).map(([k, v]) => ({ _key: k, ...v })) : [];
      refreshAll();
    }, err => {
      console.error('Erro lendo Firebase ‚Äî fallback para LocalStorage:', err);
      loadFromLocal();
    });
  } else {
    loadFromLocal();
  }
}
function loadFromLocal() {
  const stored = localStorage.getItem('transactions_backup');
  transactions = stored ? JSON.parse(stored) : [];
  refreshAll();
}
function saveLocal(){
  localStorage.setItem('transactions_backup', JSON.stringify(transactions));
}

/* ===================== CRUD ===================== */
function saveTransaction(data) {
  if (useFirebase && db) {
    if (editMode && editKey) {
      db.ref(`transactions/${editKey}`).update(data);
    } else {
      db.ref('transactions').push(data);
    }
  } else {
    if (editMode && editKey) {
      const idx = transactions.findIndex(t => t._key === editKey);
      if (idx >= 0) transactions[idx] = { ...transactions[idx], ...data };
    } else {
      data._key = String(Date.now() + Math.random());
      transactions.push(data);
    }
    saveLocal();
  }
  resetForm();
  refreshAll();
}
function deleteTransaction(key) {
  if (!confirm('Confirmar exclus√£o?')) return;
  if (useFirebase && db) {
    db.ref(`transactions/${key}`).remove();
  } else {
    transactions = transactions.filter(t => t._key !== key);
    saveLocal();
    refreshAll();
  }
}
function updateStatus(key, status) {
  if (useFirebase && db) {
    db.ref(`transactions/${key}`).update({ status });
  } else {
    const trans = transactions.find(t => t._key === key);
    if (trans) trans.status = status;
    saveLocal();
    refreshAll();
  }
}
function editTransaction(key) {
  const t = transactions.find(t => t._key === key);
  if (!t) return;
  document.getElementById('description').value = t.description;
  document.getElementById('amount').value = t.amount;
  document.getElementById('type').value = t.type;
  document.getElementById('category').value = t.category;
  document.getElementById('date').value = t.date;
  document.getElementById('installments').value = ''; // n√£o reabre em parcelas
  document.getElementById('is-recurring').checked = !!t.isRecurring;
  editMode = true;
  editKey = key;
  addTransactionBtn.textContent = 'Atualizar';
  toast('Modo edi√ß√£o ativo');
}

/* ===================== Renderiza√ß√£o ===================== */
function renderTable(data = transactions) {
  transactionsTable.innerHTML = '';
  const frag = document.createDocumentFragment();

  data.forEach(t => {
    const tr = document.createElement('tr');

    let valorClass = '';
    if (t.type === 'income') valorClass = 'income';
    else if (t.type === 'expense') valorClass = getStatus(t) === 'Pago' ? 'income' : 'expense';

    const status = getStatus(t);
    const statusHtml = (t.type === 'expense')
      ? `<select class="status-select" onchange="updateStatus('${t._key}', this.value)">
           <option value="Pendente" ${status==='Pendente'?'selected':''}>Pendente</option>
           <option value="Pago" ${status==='Pago'?'selected':''}>Pago</option>
           <option value="Atrasado" ${status==='Atrasado'?'selected':''}>Atrasado</option>
         </select>`
      : `<span class="pill pago">Pago</span>`;

    tr.innerHTML = `
      <td>${t.description}${t.isRecurring ? ' <span class="pill secondary">Recorrente</span>' : ''}${t.installmentInfo ? ` <span class="pill secondary">${t.installmentInfo}</span>`:''}</td>
      <td class="${valorClass}">${formatCurrency(t.amount)}</td>
      <td>${t.type}</td>
      <td>${t.category}</td>
      <td>${formatDateBR(t.date)}</td>
      <td>${statusHtml}</td>
      <td>
        <button class="btn secondary" onclick="editTransaction('${t._key}')">Editar</button>
        <button class="btn danger" onclick="deleteTransaction('${t._key}')">Excluir</button>
      </td>`;
    frag.appendChild(tr);
  });

  transactionsTable.appendChild(frag);
}
function updateDashboard(data = transactions) {
  const income = data.filter(t => t.type === 'income').reduce((sum, t) => sum + Number(t.amount), 0);
  const expense = data.filter(t => t.type === 'expense').reduce((sum, t) => sum + Number(t.amount), 0);
  const pending = data.filter(t => t.type==='expense' && ['Pendente','Atrasado'].includes(getStatus(t))).length;

  balanceEl.textContent = formatCurrency(income - expense);
  totalIncomeEl.textContent = formatCurrency(income);
  totalExpenseEl.textContent = formatCurrency(expense);
  pendingCountEl.textContent = pending;

  tableSummary.textContent = `${data.length} itens ‚Ä¢ Receitas: ${formatCurrency(income)} ‚Ä¢ Despesas: ${formatCurrency(expense)} ‚Ä¢ Saldo (vis√£o): ${formatCurrency(income - expense)}`;
}

/* ===================== Filtros e Busca ===================== */
function currentFilters(){
  return {
    start: filterStart.value,
    end: filterEnd.value,
    type: filterType.value,
    category: filterCategory.value,
    query: (searchInput.value || '').toLowerCase().trim()
  }
}
function applyFilters() {
  const {start, end, type, category, query} = currentFilters();

  let filtered = transactions.slice();
  if (start) filtered = filtered.filter(t => t.date >= start);
  if (end) filtered = filtered.filter(t => t.date <= end);
  if (type !== 'all') filtered = filtered.filter(t => t.type === type);
  if (category !== 'all') filtered = filtered.filter(t => t.category === category);
  if (query) filtered = filtered.filter(t => t.description && t.description.toLowerCase().includes(query));

  renderTable(filtered);
  updateDashboard(filtered);
  if (chartsContainer.style.display !== 'none') {
    updateCharts(filtered);
    updateMonthlyChart(filtered);
  }
  return filtered;
}
let searchTimer=null;
searchInput.addEventListener('input', ()=>{
  clearTimeout(searchTimer);
  searchTimer = setTimeout(applyFilters, 180);
});

/* ===================== Adicionar / Atualizar ===================== */
function addTransaction() {
  const desc = document.getElementById('description').value.trim();
  const amountVal = parseFloat(document.getElementById('amount').value);
  const typeVal = document.getElementById('type').value;
  const categoryVal = document.getElementById('category').value;
  const dateVal = document.getElementById('date').value;
  const installments = parseInt(document.getElementById('installments').value || '0',10);
  const isRecurring = document.getElementById('is-recurring').checked;

  if (!desc || isNaN(amountVal) || amountVal < 0 || !dateVal) {
    alert('Preencha todos os campos corretamente! Valor deve ser positivo.');
    return;
  }

  // Atualiza√ß√£o simples
  if (editMode && editKey) {
    saveTransaction({ description: desc, amount: amountVal, type: typeVal, category: categoryVal, date: dateVal, isRecurring: !!isRecurring });
    toast('Transa√ß√£o atualizada');
    return;
  }

  // Parcelas: gera N lan√ßamentos m√™s a m√™s
  if (installments && installments > 1) {
    for (let i=0;i<installments;i++){
      const installmentDate = addMonths(dateVal, i);
      const label = `${i+1}/${installments}`;
      saveTransaction({ description: `${desc} (${label})`, amount: amountVal, type: typeVal, category: categoryVal, date: installmentDate, installmentInfo: label, isRecurring: false });
    }
    toast(`Geradas ${installments} parcelas`);
  } else {
    // Lan√ßamento √∫nico
    saveTransaction({ description: desc, amount: amountVal, type: typeVal, category: categoryVal, date: dateVal, isRecurring: !!isRecurring });
    toast('Transa√ß√£o registrada');
  }
}
function resetForm() {
  editMode = false;
  editKey = null;
  addTransactionBtn.textContent = 'Registrar';
  document.getElementById('description').value = '';
  document.getElementById('amount').value = '';
  document.getElementById('date').value = '';
  document.getElementById('installments').value = '';
  document.getElementById('is-recurring').checked = false;
}

/* ===================== Gr√°ficos ===================== */
Chart.register(ChartDataLabels);
function updateCharts(data = transactions) {
  const income = data.filter(t => t.type === 'income').reduce((a, t) => a + Number(t.amount), 0);
  const expense = data.filter(t => t.type === 'expense').reduce((a, t) => a + Number(t.amount), 0);

  const ctx = document.getElementById('chart').getContext('2d');
  if (window.myChart) window.myChart.destroy();
  window.myChart = new Chart(ctx, {
    type: 'doughnut',
    data: { labels: ['Receitas', 'Despesas'], datasets: [{ data: [income, expense], backgroundColor: ['#2ecc71', '#e74c3c'] }] },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '55%',
      plugins: {
        legend: { position: 'bottom' },
        datalabels: { color: '#fff', font:{weight:'bold'},
          formatter: (value, ctxI) => `${ctxI.chart.data.labels[ctxI.dataIndex]}\n${formatCurrency(value)}\n${((value/(income+expense))*100 || 0).toFixed(1)}%`
        },
        tooltip: { callbacks:{ label: (c)=> `${c.label}: ${formatCurrency(c.parsed)}` } }
      }
    }
  });

  // Status doughnut (contagem)
  const statusCounts = {};
  const statusSums = {};
  data.forEach(t => {
    const s = getStatus(t);
    statusCounts[s] = (statusCounts[s] || 0) + 1;
    statusSums[s] = (statusSums[s] || 0) + Number(t.amount);
  });
  const ctx2 = document.getElementById('status-chart').getContext('2d');
  if (window.statusChart) window.statusChart.destroy();
  window.statusChart = new Chart(ctx2, {
    type: 'doughnut',
    data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#22c55e','#f59e0b','#ef4444'] }] },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '55%',
      plugins: {
        legend: { position: 'bottom' },
        datalabels: {
          color: '#fff', font:{weight:'bold'},
          formatter: (count, ctxD) => {
            const label = ctxD.chart.data.labels[ctxD.dataIndex];
            return `${label}\n${count} item(s)\n${formatCurrency(statusSums[label]||0)}`;
          }
        }
      }
    }
  });

  // Categorias din√¢micas (somente despesas)
  const catMap = {};
  data.filter(t=>t.type==='expense').forEach(t => {
    catMap[t.category] = (catMap[t.category] || 0) + Number(t.amount);
  });
  const catLabels = Object.keys(catMap);
  const catValues = Object.values(catMap);

  const ctx3 = document.getElementById('category-chart').getContext('2d');
  if (window.categoryChart) window.categoryChart.destroy();
  window.categoryChart = new Chart(ctx3, {
    type: 'bar',
    data: { labels: catLabels, datasets: [{ label: 'Despesas por Categoria', data: catValues, backgroundColor: '#3498db' }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        datalabels: {
          color: '#000', anchor: 'end', align: 'top',
          formatter: v => `${formatCurrency(v)}\n(${(v/(catValues.reduce((a,b)=>a+b,0))*100 || 0).toFixed(1)}%)`
        },
        tooltip: { callbacks:{ label:(c)=> `${c.dataset.label}: ${formatCurrency(c.parsed.y)}` } }
      },
      scales: {
        y: { beginAtZero: true, ticks: { callback: value => formatCurrency(value) } }
      }
    }
  });
}
function updateMonthlyChart(data = transactions) {
  const months = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  const incomeMonthly = Array(12).fill(0);
  const expenseMonthly = Array(12).fill(0);

  data.forEach(t => {
    const d = new Date(t.date);
    if (!isNaN(d)) {
      const m = d.getMonth();
      t.type === 'income' ? incomeMonthly[m] += Number(t.amount) : expenseMonthly[m] += Number(t.amount);
    }
  });

  const ctx = document.getElementById('monthly-chart').getContext('2d');
  if (window.monthlyChart) window.monthlyChart.destroy();
  window.monthlyChart = new Chart(ctx, {
    type: 'line',
    data: { labels: months, datasets: [
      { label: 'Receitas', data: incomeMonthly, borderColor: '#2ecc71', backgroundColor: 'rgba(46,204,113,0.2)', fill: true, tension: 0.35 },
      { label: 'Despesas', data: expenseMonthly, borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.2)', fill: true, tension: 0.35 },
    ]},
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' },
        datalabels: { color: '#000', anchor: 'end', align: 'top', formatter: v => (v>0?formatCurrency(v):'') },
        tooltip: { callbacks:{ label:(c)=> `${c.dataset.label}: ${formatCurrency(c.parsed.y)}` } }
      },
      scales: {
        y: { beginAtZero: true, ticks: { callback: v => formatCurrency(v) } }
      }
    }
  });
}

/* ===================== Exporta√ß√µes ===================== */
function exportCSV(allData = transactions) {
  let csv = 'Descri√ß√£o,Valor,Tipo,Categoria,Data,Status\n';
  allData.forEach(t => {
    csv += `"${(t.description||'').replace(/"/g,'""')}",${t.amount},"${t.type}","${t.category}","${t.date}","${getStatus(t)}"\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'transacoes.csv';
  link.click();
}
function exportXLSX(allData = transactions){
  const rows = [['Descri√ß√£o','Valor','Tipo','Categoria','Data','Status']];
  allData.forEach(t => rows.push([t.description, Number(t.amount), t.type, t.category, t.date, getStatus(t)]));
  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = [{wch:40},{wch:12},{wch:10},{wch:16},{wch:12},{wch:12}];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Transa√ß√µes');
  XLSX.writeFile(wb, 'transacoes.xlsx');
}
function exportPDF(allData = transactions, filename='transacoes.pdf'){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'l', unit:'pt', format:'a4'});
  doc.setFontSize(16);
  doc.text('Relat√≥rio Financeiro', 40, 40);
  const income = allData.filter(t=>t.type==='income').reduce((s,t)=>s+Number(t.amount),0);
  const expense = allData.filter(t=>t.type==='expense').reduce((s,t)=>s+Number(t.amount),0);
  doc.setFontSize(11);
  doc.text(`Itens: ${allData.length} ‚Ä¢ Receitas: ${formatCurrency(income)} ‚Ä¢ Despesas: ${formatCurrency(expense)} ‚Ä¢ Saldo: ${formatCurrency(income-expense)}`, 40, 62);
  const rows = allData.map(t => [t.description, formatCurrency(t.amount), t.type, t.category, formatDateBR(t.date), getStatus(t)]);
  doc.autoTable({
    head: [['Descri√ß√£o','Valor','Tipo','Categoria','Data','Status']],
    body: rows,
    startY: 80,
    styles: { fontSize: 9 },
    headStyles: { fillColor: [44,62,80] }
  });
  doc.save(filename);
}

/* ===================== Datas padr√£o e Recorr√™ncias ===================== */
function setDefaultDateFilters() {
  const now = new Date();
  const y = now.getFullYear(), m = now.getMonth();
  filterStart.value = `${y}-${String(m+1).padStart(2,'0')}-01`;
  const lastDay = new Date(y, m+1, 0).getDate();
  filterEnd.value = `${y}-${String(m+1).padStart(2,'0')}-${lastDay}`;
}
function applyRecurrences(){
  // Gera lan√ßamentos para transa√ß√µes marcadas como recorrentes se ainda n√£o houver no m√™s corrente
  const now = new Date();
  const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const rec = transactions.filter(t => t.isRecurring);
  let created = 0;

  rec.forEach(t => {
    const exists = transactions.some(x =>
      x.isRecurring && x.description===t.description &&
      (x.date || '').startsWith(ym)
    );
    if (!exists) {
      const baseDay = (new Date(t.date)).getDate();
      const d = new Date(now.getFullYear(), now.getMonth(), baseDay);
      const dateVal = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      saveTransaction({ description: t.description, amount: Number(t.amount), type: t.type, category: t.category, date: dateVal, isRecurring:true });
      created++;
    }
  });
  if (created>0) toast(`Recorr√™ncias geradas: ${created}`);
}

/* ===================== Refresh ===================== */
function refreshAll() {
  const filtered = applyFilters(); // tamb√©m renderiza
  // Se gr√°ficos estiverem vis√≠veis, j√° atualizados em applyFilters()
}

/* ===================== Eventos ===================== */
addTransactionBtn.addEventListener('click', addTransaction);
document.getElementById('apply-filters').addEventListener('click', applyFilters);

toggleChartsBtn.addEventListener('click', () => {
  const show = chartsContainer.style.display === 'none';
  chartsContainer.style.display = show ? 'flex' : 'none';
  toggleChartsBtn.textContent = show ? 'üìâ Ocultar Gr√°ficos' : 'üìà Mostrar Gr√°ficos';
  if (show) { updateCharts(applyFilters()); updateMonthlyChart(applyFilters()); }
});

exportCsvBtn.addEventListener('click', ()=> exportCSV(applyFilters()));
exportXlsxBtn.addEventListener('click', ()=> exportXLSX(applyFilters()));
exportPdfBtn.addEventListener('click', ()=> exportPDF(applyFilters(), 'transacoes-filtradas.pdf'));
quickReportBtn.addEventListener('click', ()=> exportPDF(transactions, 'relatorio-completo.pdf'));

backupBtn.addEventListener('click', ()=>{
  saveLocal();
  toast('Backup salvo no navegador');
});
restoreBtn.addEventListener('click', ()=>{
  loadFromLocal();
  toast('Backup restaurado do navegador');
});
clearAllBtn.addEventListener('click', ()=>{
  if (!confirm('Isto remover√° TODAS as transa√ß√µes. Deseja continuar?')) return;
  if (useFirebase && db) {
    db.ref('transactions').remove();
  } else {
    transactions = [];
    saveLocal();
    refreshAll();
  }
  toast('Base limpa');
});

themeToggle.addEventListener('click', ()=>{
  const willDark = !document.body.classList.contains('dark');
  document.body.classList.toggle('dark', willDark);
  localStorage.setItem('theme', willDark ? 'dark':'light');
});

document.addEventListener('keydown', (e)=>{
  // atalhos
  if (e.key==='Enter' && (document.activeElement.closest('#tx-form'))) {
    e.preventDefault(); addTransaction();
  }
  if (e.ctrlKey && (e.key==='s' || e.key==='S')) {
    e.preventDefault(); exportCSV(applyFilters()); toast('CSV exportado (Ctrl+S)');
  }
});

/* ===================== Init ===================== */
window.onload = () => {
  // Tema salvo
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') document.body.classList.add('dark');

  setDefaultDateFilters();
  loadTransactions();

  // Gera recorr√™ncias ap√≥s carregar
  setTimeout(applyRecurrences, 600);
};
</script>

</body>
</html>
