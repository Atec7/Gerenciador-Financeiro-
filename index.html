<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Financeiro Avançado</title>
  <style>
    /* (seu CSS permanece o mesmo, com pequenos ajustes) */
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
    :root{ --bg:#f0f2f5; --card:#fff; --accent:#2ecc71; --danger:#e74c3c; }
    body { margin:0; font-family:'Roboto',sans-serif; background:var(--bg); color:#333; }
    header { background: linear-gradient(90deg,#0f2027,#203a43,#2c5364); color:#fff; padding:20px; text-align:center; font-size:26px; font-weight:bold; }
    .container { max-width:1200px; margin:auto; padding:20px; }
    .dashboard { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
    .card { background:var(--card); border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); padding:20px; transition: transform 0.2s; text-align:center; }
    .card:hover { transform: translateY(-5px); }
    .card h3 { margin:0 0 10px; font-size:18px; color:#555; }
    .card p { font-size:22px; font-weight:bold; }
    .transaction-form { background:var(--card); padding:20px; border-radius:12px; margin-bottom:10px; box-shadow:0 4px 15px rgba(0,0,0,0.1); display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); }
    .transaction-form input, .transaction-form select, .transaction-form button { padding:10px; border-radius:8px; border:1px solid #ccc; }
    .transaction-form input[type="number"]{ text-align:right; }
    .transaction-form button { background:var(--accent); color:white; border:none; cursor:pointer; transition:0.2s; }
    .transaction-form button:hover { filter:brightness(.95); }
    .filters { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
    .filters input, .filters select, .filters button { padding:8px; border-radius:8px; border:1px solid #ccc; }
    table { width:100%; border-collapse:collapse; background:var(--card); border-radius:12px; overflow:hidden; box-shadow:0 4px 15px rgba(0,0,0,0.1); margin-bottom:20px; }
    th, td { padding:12px; text-align:left; }
    th { background:#2c3e50; color:white; }
    tr:nth-child(even) { background:#f2f2f2; }
    .income { color:green; font-weight:bold; }
    .expense { color:red; font-weight:bold; }
    .status-select { border:none; font-weight:bold; width:100%; background:transparent; cursor:pointer; }
    .export-btn, #toggle-charts { background:#3498db; color:white; padding:10px 15px; border:none; border-radius:8px; cursor:pointer; margin-bottom:20px; }
    .export-btn:hover, #toggle-charts:hover { filter:brightness(.9); }
    .charts-row { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; margin-bottom:30px; }
    .chart-box { background:var(--card); border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); padding:16px; flex:1 1 360px; min-width:300px; max-width:520px; }
    .chart-box canvas { width:100% !important; height:300px !important; }
    #monthly-chart { max-height:300px !important; margin-bottom:30px; width:100% !important; }
    @media (max-width:700px){ .transaction-form{ grid-template-columns:1fr 1fr; } }
  </style>
</head>
<body>

<header>Sistema Financeiro</header>
<div class="container">

  <div class="dashboard">
    <div class="card"><h3>Saldo Atual</h3><p id="balance">R$ 0,00</p></div>
    <div class="card"><h3>Total Receitas</h3><p id="total-income">R$ 0,00</p></div>
    <div class="card"><h3>Total Despesas</h3><p id="total-expense">R$ 0,00</p></div>
    <div class="card"><h3>Despesas Pendentes</h3><p id="pending-count">0</p></div>
  </div>

  <div class="transaction-form">
    <input type="text" id="description" placeholder="Descrição" required>
    <input type="number" id="amount" placeholder="Valor" required step="0.01" min="0">
    <select id="type">
      <option value="income">Receita</option>
      <option value="expense">Despesa</option>
    </select>
    <select id="category">
      <option value="salario">Salário</option>
      <option value="alimentacao">Alimentação</option>
      <option value="transporte">Transporte</option>
      <option value="Farmácia">Farmácia</option>
      <option value="Empréstimo">Empréstimo</option>
      <option value="lazer">Lazer</option>
      <option value="outros">Outros</option>
    </select>
    <input type="date" id="date" required>
    <button id="add-transaction">Registrar</button>
  </div>

  <div class="filters">
    <input type="date" id="filter-start">
    <input type="date" id="filter-end">
    <select id="filter-type">
      <option value="all">Todos</option>
      <option value="income">Receitas</option>
      <option value="expense">Despesas</option>
    </select>
    <select id="filter-category">
      <option value="all">Todas Categorias</option>
      <option value="salario">Salário</option>
      <option value="alimentacao">Alimentação</option>
      <option value="transporte">Transporte</option>
      <option value="Farmácia">Farmácia</option>
      <option value="Empréstimo">Empréstimo</option>
      <option value="lazer">Lazer</option>
      <option value="outros">Outros</option>
    </select>
    <button id="apply-filters">Filtrar</button>
  </div>

  <button class="export-btn" id="export-csv">Exportar CSV</button>
  <button id="toggle-charts">Mostrar Gráficos</button>

  <div id="charts-container" class="charts-row" style="display:none;">
    <div class="chart-box"><canvas id="chart"></canvas></div>
    <div class="chart-box"><canvas id="status-chart"></canvas></div>
    <div class="chart-box"><canvas id="category-chart"></canvas></div>
  </div>

  <canvas id="monthly-chart"></canvas>

  <table>
    <thead>
      <tr>
        <th>Descrição</th><th>Valor</th><th>Tipo</th><th>Categoria</th><th>Data</th><th>Status</th><th>Ações</th>
      </tr>
    </thead>
    <tbody id="transactions-table"></tbody>
  </table>

</div>

<!-- Firebase compat (usamos os bundles compat para permitir firebase.database() semelhante ao v8) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<!-- Chart.js UMD + plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<script>
// Configuração do Firebase (mantida)
const firebaseConfig = {
  apiKey: "AIzaSyDXDB6jbRy3o1eXcdXqmd8zrplDk1IezqM",
  authDomain: "sistema-financeiro-51295.firebaseapp.com",
  projectId: "sistema-financeiro-51295",
  storageBucket: "sistema-financeiro-51295.appspot.com",
  messagingSenderId: "340721821688",
  appId: "1:340721821688:web:77485712a056405f5f180d",
  measurementId: "G-X30NBWCY92",
  databaseURL: "https://sistema-financeiro-51295-default-rtdb.firebaseio.com"
};

let useFirebase = false;
let db = null;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  useFirebase = true;
  console.log('Firebase conectado');
} catch (e) {
  console.warn('Firebase não disponível — usando LocalStorage.', e);
}

// Elementos da interface
const balanceEl = document.getElementById('balance');
const totalIncomeEl = document.getElementById('total-income');
const totalExpenseEl = document.getElementById('total-expense');
const pendingCountEl = document.getElementById('pending-count');
const transactionsTable = document.getElementById('transactions-table');
const addTransactionBtn = document.getElementById('add-transaction');
const exportBtn = document.getElementById('export-csv');
const toggleChartsBtn = document.getElementById('toggle-charts');
const chartsContainer = document.getElementById('charts-container');
const filterStart = document.getElementById('filter-start');
const filterEnd = document.getElementById('filter-end');

let transactions = [];
let editMode = false;
let editKey = null;

// Utilitários
function formatCurrency(value) {
  const num = Number(value) || 0;
  return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(num);
}
function formatDateBR(dateStr) {
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
}
function getStatus(t) {
  if (t.type === 'income') return 'Pago';
  if (t.status) return t.status;
  const today = new Date().toISOString().split('T')[0];
  return t.date < today ? 'Atrasado' : 'Pendente';
}

// Carregar transações
function loadTransactions() {
  if (useFirebase && db) {
    db.ref('transactions').on('value', snapshot => {
      const val = snapshot.val();
      transactions = val ? Object.entries(val).map(([k, v]) => ({ _key: k, ...v })) : [];
      refreshAll();
    }, err => {
      console.error('Erro lendo Firebase — fallback para LocalStorage:', err);
      loadFromLocal();
    });
  } else {
    loadFromLocal();
  }
}
function loadFromLocal() {
  const stored = localStorage.getItem('transactions_backup');
  transactions = stored ? JSON.parse(stored) : [];
  refreshAll();
}

// Salvar transação
function saveTransaction(data) {
  if (useFirebase && db) {
    if (editMode && editKey) {
      db.ref(`transactions/${editKey}`).update(data);
    } else {
      db.ref('transactions').push(data);
    }
  } else {
    if (editMode && editKey) {
      const idx = transactions.findIndex(t => t._key === editKey);
      if (idx >= 0) transactions[idx] = { ...transactions[idx], ...data };
    } else {
      data._key = String(Date.now());
      transactions.push(data);
    }
    localStorage.setItem('transactions_backup', JSON.stringify(transactions));
  }
  resetForm();
  refreshAll();
}

// Excluir
function deleteTransaction(key) {
  if (useFirebase && db) {
    db.ref(`transactions/${key}`).remove();
  } else {
    transactions = transactions.filter(t => t._key !== key);
    localStorage.setItem('transactions_backup', JSON.stringify(transactions));
    refreshAll();
  }
}

// Atualizar status
function updateStatus(key, status) {
  if (useFirebase && db) {
    db.ref(`transactions/${key}`).update({ status });
  } else {
    const trans = transactions.find(t => t._key === key);
    if (trans) trans.status = status;
    localStorage.setItem('transactions_backup', JSON.stringify(transactions));
    refreshAll();
  }
}

// Editar
function editTransaction(key) {
  const t = transactions.find(t => t._key === key);
  if (!t) return;
  document.getElementById('description').value = t.description;
  document.getElementById('amount').value = t.amount;
  document.getElementById('type').value = t.type;
  document.getElementById('category').value = t.category;
  document.getElementById('date').value = t.date;
  editMode = true;
  editKey = key;
  addTransactionBtn.textContent = 'Atualizar';
}

// Tabela
function renderTable(data = transactions) {
  transactionsTable.innerHTML = '';
  data.forEach(t => {
    const tr = document.createElement('tr');

    // Determina a cor do valor
    let valorClass = '';
    if (t.type === 'income') {
      valorClass = 'income';
    } else if (t.type === 'expense') {
      if (getStatus(t) === 'Pago') {
        valorClass = 'income'; // verde
      } else {
        valorClass = 'expense'; // vermelho
      }
    }

    tr.innerHTML = `
      <td>${t.description}</td>
      <td class="${valorClass}">${formatCurrency(t.amount)}</td>
      <td>${t.type}</td>
      <td>${t.category}</td>
      <td>${formatDateBR(t.date)}</td>
      <td>
        ${t.type === 'expense'
        ? `<select class="status-select" onchange="updateStatus('${t._key}', this.value)">
            <option value="Pendente" ${getStatus(t)==='Pendente'?'selected':''}>Pendente</option>
            <option value="Pago" ${getStatus(t)==='Pago'?'selected':''}>Pago</option>
            <option value="Atrasado" ${getStatus(t)==='Atrasado'?'selected':''}>Atrasado</option>
           </select>`
        : getStatus(t)}
      </td>
      <td>
        <button onclick="editTransaction('${t._key}')">Editar</button>
        <button onclick="deleteTransaction('${t._key}')">Excluir</button>
      </td>`;
    transactionsTable.appendChild(tr);
  });
}


// Cards
function updateDashboard(data = transactions) {
  const income = data.filter(t => t.type === 'income').reduce((sum, t) => sum + Number(t.amount), 0);
  const expense = data.filter(t => t.type === 'expense').reduce((sum, t) => sum + Number(t.amount), 0);
  balanceEl.textContent = formatCurrency(income - expense);
  totalIncomeEl.textContent = formatCurrency(income);
  totalExpenseEl.textContent = formatCurrency(expense);
  pendingCountEl.textContent = data.filter(t => ['Pendente','Atrasado'].includes(getStatus(t))).length;
}

// Filtros
function applyFilters() {
  const start = filterStart.value;
  const end = filterEnd.value;
  const typeF = document.getElementById('filter-type').value;
  const catF = document.getElementById('filter-category').value;

  let filtered = transactions.slice();
  if (start) filtered = filtered.filter(t => t.date >= start);
  if (end) filtered = filtered.filter(t => t.date <= end);
  if (typeF !== 'all') filtered = filtered.filter(t => t.type === typeF);
  if (catF !== 'all') filtered = filtered.filter(t => t.category === catF);

  renderTable(filtered);
  updateDashboard(filtered);
  if (chartsContainer.style.display !== 'none') {
    updateCharts(filtered);
    updateMonthlyChart(filtered);
  }
}

// Adicionar
function addTransaction() {
  const desc = document.getElementById('description').value.trim();
  const amountVal = parseFloat(document.getElementById('amount').value);
  const typeVal = document.getElementById('type').value;
  const categoryVal = document.getElementById('category').value;
  const dateVal = document.getElementById('date').value;
  if (!desc || isNaN(amountVal) || !dateVal) return alert('Preencha todos os campos!');
  const data = { description: desc, amount: amountVal, type: typeVal, category: categoryVal, date: dateVal };
  saveTransaction(data);
}

// Reset form
function resetForm() {
  editMode = false;
  editKey = null;
  addTransactionBtn.textContent = 'Registrar';
  document.getElementById('description').value = '';
  document.getElementById('amount').value = '';
  document.getElementById('date').value = '';
}

// Gráficos
function updateCharts(data = transactions) {
  const income = data.filter(t => t.type === 'income').reduce((a, t) => a + t.amount, 0);
  const expense = data.filter(t => t.type === 'expense').reduce((a, t) => a + t.amount, 0);

  const ctx = document.getElementById('chart').getContext('2d');
  if (window.myChart) window.myChart.destroy();
  window.myChart = new Chart(ctx, {
    type: 'doughnut',
    data: { labels: ['Receitas', 'Despesas'], datasets: [{ data: [income, expense], backgroundColor: ['#2ecc71', '#e74c3c'] }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' },
        datalabels: { color: '#fff', formatter: (value) => `${formatCurrency(value)}\n(${((value/(income+expense))*100 || 0).toFixed(1)}%)` }
      },
      cutout: '50%'
    }
  });

  const statusCounts = {};
  const statusSums = {};
  data.forEach(t => {
    const s = getStatus(t);
    statusCounts[s] = (statusCounts[s] || 0) + 1;
    statusSums[s] = (statusSums[s] || 0) + t.amount;
  });

  const ctx2 = document.getElementById('status-chart').getContext('2d');
  if (window.statusChart) window.statusChart.destroy();
  window.statusChart = new Chart(ctx2, {
    type: 'doughnut',
    data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#27ae60','#f39c12','#e74c3c'] }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' },
        datalabels: {
          color: '#fff',
          formatter: (count, ctxD) => {
            const label = ctxD.chart.data.labels[ctxD.dataIndex];
            return `${label}\n${count} item(s)\n${formatCurrency(statusSums[label]||0)}`;
          }
        }
      },
      cutout: '50%'
    }
  });

  const categories = ['salario','alimentacao','transporte','lazer','outros'];
  const catLabels = ['Salário','Alimentação','Transporte','Lazer','Outros'];
  const catValues = categories.map(cat => data.filter(t => t.category === cat && t.type === 'expense').reduce((s, t) => s + t.amount, 0));

  const ctx3 = document.getElementById('category-chart').getContext('2d');
  if (window.categoryChart) window.categoryChart.destroy();
  window.categoryChart = new Chart(ctx3, {
    type: 'bar',
    data: { labels: catLabels, datasets: [{ label: 'Despesas por Categoria', data: catValues, backgroundColor: ['#1abc9c','#3498db','#9b59b6','#e67e22','#e74c3c'] }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        datalabels: {
          color: '#000',
          anchor: 'end',
          align: 'top',
          formatter: v => `${formatCurrency(v)}\n(${(v/(catValues.reduce((a,b)=>a+b,0))*100 || 0).toFixed(1)}%)`
        }
      },
      scales: {
        y: { beginAtZero: true, ticks: { callback: value => formatCurrency(value) } }
      }
    }
  });
}

function updateMonthlyChart(data = transactions) {
  const months = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  const incomeMonthly = Array(12).fill(0);
  const expenseMonthly = Array(12).fill(0);

  data.forEach(t => {
    const d = new Date(t.date);
    if (!isNaN(d)) {
      const m = d.getMonth();
      t.type === 'income' ? incomeMonthly[m] += t.amount : expenseMonthly[m] += t.amount;
    }
  });

  const ctx = document.getElementById('monthly-chart').getContext('2d');
  if (window.monthlyChart) window.monthlyChart.destroy();
  window.monthlyChart = new Chart(ctx, {
    type: 'line',
    data: { labels: months, datasets: [
      { label: 'Receitas', data: incomeMonthly, borderColor: '#2ecc71', backgroundColor: 'rgba(46,204,113,0.2)', fill: true, tension: 0.3 },
      { label: 'Despesas', data: expenseMonthly, borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.2)', fill: true, tension: 0.3 },
    ]},
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' },
        datalabels: { color: '#000', anchor: 'end', align: 'top', formatter: v => formatCurrency(v) }
      },
      scales: {
        y: { beginAtZero: true, ticks: { callback: v => formatCurrency(v) } }
      }
    }
  });
}

// Exportar CSV
function exportCSV() {
  let csv = 'Descrição,Valor,Tipo,Categoria,Data,Status\n';
  transactions.forEach(t => {
    csv += `"${t.description}",${t.amount},"${t.type}","${t.category}","${t.date}","${getStatus(t)}"\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'transacoes.csv';
  link.click();
}

// Data padrão filtros
function setDefaultDateFilters() {
  const now = new Date();
  const y = now.getFullYear(), m = now.getMonth();
  filterStart.value = `${y}-${String(m+1).padStart(2,'0')}-01`;
  const lastDay = new Date(y, m+1, 0).getDate();
  filterEnd.value = `${y}-${String(m+1).padStart(2,'0')}-${lastDay}`;
}

// Refresh
function refreshAll() {
  renderTable();
  updateDashboard();
  if (chartsContainer.style.display !== 'none') {
    updateCharts();
    updateMonthlyChart();
  }
}

// Eventos
addTransactionBtn.addEventListener('click', addTransaction);
exportBtn.addEventListener('click', exportCSV);
document.getElementById('apply-filters').addEventListener('click', applyFilters);
toggleChartsBtn.addEventListener('click', () => {
  const show = chartsContainer.style.display === 'none';
  chartsContainer.style.display = show ? 'flex' : 'none';
  toggleChartsBtn.textContent = show ? 'Ocultar Gráficos' : 'Mostrar Gráficos';
  if (show) {
    updateCharts();
    updateMonthlyChart();
  }
});

// Init
window.onload = () => {
  setDefaultDateFilters();
  loadTransactions();
};
</script>


</body>
</html>
