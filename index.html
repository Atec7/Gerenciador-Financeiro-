<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Financeiro Avançado</title>
  <style>
    /* (seu CSS permanece o mesmo, com pequenos ajustes) */
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
    :root{ --bg:#f0f2f5; --card:#fff; --accent:#2ecc71; --danger:#e74c3c; }
    body { margin:0; font-family:'Roboto',sans-serif; background:var(--bg); color:#333; }
    header { background: linear-gradient(90deg,#0f2027,#203a43,#2c5364); color:#fff; padding:20px; text-align:center; font-size:26px; font-weight:bold; }
    .container { max-width:1200px; margin:auto; padding:20px; }
    .dashboard { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
    .card { background:var(--card); border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); padding:20px; transition: transform 0.2s; text-align:center; }
    .card:hover { transform: translateY(-5px); }
    .card h3 { margin:0 0 10px; font-size:18px; color:#555; }
    .card p { font-size:22px; font-weight:bold; }
    .transaction-form { background:var(--card); padding:20px; border-radius:12px; margin-bottom:10px; box-shadow:0 4px 15px rgba(0,0,0,0.1); display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); }
    .transaction-form input, .transaction-form select, .transaction-form button { padding:10px; border-radius:8px; border:1px solid #ccc; }
    .transaction-form input[type="number"]{ text-align:right; }
    .transaction-form button { background:var(--accent); color:white; border:none; cursor:pointer; transition:0.2s; }
    .transaction-form button:hover { filter:brightness(.95); }
    .filters { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
    .filters input, .filters select, .filters button { padding:8px; border-radius:8px; border:1px solid #ccc; }
    table { width:100%; border-collapse:collapse; background:var(--card); border-radius:12px; overflow:hidden; box-shadow:0 4px 15px rgba(0,0,0,0.1); margin-bottom:20px; }
    th, td { padding:12px; text-align:left; }
    th { background:#2c3e50; color:white; }
    tr:nth-child(even) { background:#f2f2f2; }
    .income { color:green; font-weight:bold; }
    .expense { color:red; font-weight:bold; }
    .status-select { border:none; font-weight:bold; width:100%; background:transparent; cursor:pointer; }
    .export-btn, #toggle-charts { background:#3498db; color:white; padding:10px 15px; border:none; border-radius:8px; cursor:pointer; margin-bottom:20px; }
    .export-btn:hover, #toggle-charts:hover { filter:brightness(.9); }
    .charts-row { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; margin-bottom:30px; }
    .chart-box { background:var(--card); border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); padding:16px; flex:1 1 360px; min-width:300px; max-width:520px; }
    .chart-box canvas { width:100% !important; height:300px !important; }
    #monthly-chart { max-height:300px !important; margin-bottom:30px; width:100% !important; }
    @media (max-width:700px){ .transaction-form{ grid-template-columns:1fr 1fr; } }
  </style>
</head>
<body>

<header>Sistema Financeiro</header>
<div class="container">

  <div class="dashboard">
    <div class="card"><h3>Saldo Atual</h3><p id="balance">R$ 0,00</p></div>
    <div class="card"><h3>Total Receitas</h3><p id="total-income">R$ 0,00</p></div>
    <div class="card"><h3>Total Despesas</h3><p id="total-expense">R$ 0,00</p></div>
    <div class="card"><h3>Despesas Pendentes</h3><p id="pending-count">0</p></div>
  </div>

  <div class="transaction-form">
    <input type="text" id="description" placeholder="Descrição" required>
    <input type="number" id="amount" placeholder="Valor" required step="0.01" min="0">
    <select id="type">
      <option value="income">Receita</option>
      <option value="expense">Despesa</option>
    </select>
    <select id="category">
      <option value="salario">Salário</option>
      <option value="alimentacao">Alimentação</option>
      <option value="transporte">Transporte</option>
      <option value="lazer">Lazer</option>
      <option value="outros">Outros</option>
    </select>
    <input type="date" id="date" required>
    <button id="add-transaction">Registrar</button>
  </div>

  <div class="filters">
    <input type="date" id="filter-start">
    <input type="date" id="filter-end">
    <select id="filter-type">
      <option value="all">Todos</option>
      <option value="income">Receitas</option>
      <option value="expense">Despesas</option>
    </select>
    <select id="filter-category">
      <option value="all">Todas Categorias</option>
      <option value="salario">Salário</option>
      <option value="alimentacao">Alimentação</option>
      <option value="transporte">Transporte</option>
      <option value="lazer">Lazer</option>
      <option value="outros">Outros</option>
    </select>
    <button id="apply-filters">Filtrar</button>
  </div>

  <button class="export-btn" id="export-csv">Exportar CSV</button>
  <button id="toggle-charts">Mostrar Gráficos</button>

  <div id="charts-container" class="charts-row" style="display:none;">
    <div class="chart-box"><canvas id="chart"></canvas></div>
    <div class="chart-box"><canvas id="status-chart"></canvas></div>
    <div class="chart-box"><canvas id="category-chart"></canvas></div>
  </div>

  <canvas id="monthly-chart"></canvas>

  <table>
    <thead>
      <tr>
        <th>Descrição</th><th>Valor</th><th>Tipo</th><th>Categoria</th><th>Data</th><th>Status</th><th>Ações</th>
      </tr>
    </thead>
    <tbody id="transactions-table"></tbody>
  </table>

</div>

<!-- Firebase compat (usamos os bundles compat para permitir firebase.database() semelhante ao v8) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<!-- Chart.js UMD + plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<script>
// registra plugin
if(typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);

// Sua configuração do Firebase (mantive a sua config)
const firebaseConfig = {
  apiKey: "AIzaSyDXDB6jbRy3o1eXcdXqmd8zrplDk1IezqM",
  authDomain: "sistema-financeiro-51295.firebaseapp.com",
  projectId: "sistema-financeiro-51295",
  storageBucket: "sistema-financeiro-51295.firebasestorage.app",
  messagingSenderId: "340721821688",
  appId: "1:340721821688:web:77485712a056405f5f180d",
  measurementId: "G-X30NBWCY92",
  databaseURL: "https://sistema-financeiro-51295-default-rtdb.firebaseio.com"
};

let useFirebase = false;
let db = null;
try{
  if(window.firebase && firebase.initializeApp){
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    useFirebase = true;
    console.log('Firebase conectado (compat)');
  }
}catch(e){ console.warn('Firebase não disponível, usando LocalStorage como fallback.', e); useFirebase = false; }

const balanceEl = document.getElementById('balance');
const totalIncomeEl = document.getElementById('total-income');
const totalExpenseEl = document.getElementById('total-expense');
const pendingCountEl = document.getElementById('pending-count');
const transactionsTable = document.getElementById('transactions-table');
const addTransactionBtn = document.getElementById('add-transaction');
const exportBtn = document.getElementById('export-csv');
const toggleChartsBtn = document.getElementById('toggle-charts');
const chartsContainer = document.getElementById('charts-container');

let transactions = [];

// Carrega transações do Firebase ou LocalStorage
function loadTransactions(){
  if(useFirebase && db){
    db.ref('transactions').on('value', snapshot => {
      const val = snapshot.val();
      transactions = val ? Object.keys(val).map(k => ({ _key: k, ...val[k] })) : [];
      // mantemos um backup local
      try{ localStorage.setItem('transactions_backup', JSON.stringify(transactions)); }catch(e){}
      refreshAll();
    }, err => {
      console.error('Erro ao ler Firebase:', err);
      loadFromLocal();
    });
  } else {
    loadFromLocal();
  }
}
function loadFromLocal(){
  const stored = localStorage.getItem('transactions_backup') || localStorage.getItem('transactions');
  if(stored){
    try{ transactions = JSON.parse(stored); }catch(e){ transactions = []; }
  } else transactions = [];
  refreshAll();
}

// Salva uma nova transação (Firebase ou LocalStorage)
function saveTransaction(transaction) {
  if(useFirebase && db){
    const newRef = db.ref('transactions').push();
    newRef.set(transaction).catch(e => {
      console.error('Erro ao salvar no Firebase, salvando localmente', e);
      transaction._key = String(Date.now());
      transactions.push(transaction);
      localStorage.setItem('transactions_backup', JSON.stringify(transactions));
      refreshAll();
    });
  } else {
    transaction._key = String(Date.now());
    transactions.push(transaction);
    try{ localStorage.setItem('transactions_backup', JSON.stringify(transactions)); }catch(e){}
    refreshAll();
  }
}

function formatCurrency(value){
  const num = Number(value) || 0;
  return new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' }).format(num);
}
function formatDateBR(dateStr){
  if(!dateStr) return '';
  const d = new Date(dateStr);
  if(isNaN(d)) return dateStr;
  return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
}
function getStatus(t){
  if(t.type === 'income') return 'Pago';
  if(t.status) return t.status;
  const today = new Date().toISOString().split('T')[0];
  return t.date < today ? 'Atrasado' : 'Pendente';
}

function updateDashboard(){
  const income = transactions.filter(t => t.type === 'income').reduce((a,t) => a + Number(t.amount || 0), 0);
  const expense = transactions.filter(t => t.type === 'expense').reduce((a,t) => a + Number(t.amount || 0), 0);
  balanceEl.textContent = formatCurrency(income - expense);
  totalIncomeEl.textContent = formatCurrency(income);
  totalExpenseEl.textContent = formatCurrency(expense);
  pendingCountEl.textContent = transactions.filter(t => ['Pendente','Atrasado'].includes(getStatus(t))).length;
}

function renderTable(filtered = transactions){
  transactionsTable.innerHTML = '';
  filtered.forEach((t) => {
    const status = getStatus(t);
    const tr = document.createElement('tr');
    // Cria células manualmente para evitar problemas com quotes
    const tdDesc = document.createElement('td'); tdDesc.textContent = t.description || '';
    const tdVal = document.createElement('td'); tdVal.className = t.type === 'income' ? 'income' : 'expense'; tdVal.textContent = formatCurrency(t.amount);
    const tdType = document.createElement('td'); tdType.textContent = t.type;
    const tdCat = document.createElement('td'); tdCat.textContent = t.category || '';
    const tdDate = document.createElement('td'); tdDate.textContent = formatDateBR(t.date);
    const tdStatus = document.createElement('td');
    if(t.type === 'expense'){
      const sel = document.createElement('select'); sel.className = 'status-select';
      ['Pendente','Pago','Atrasado'].forEach(opt => { const o = document.createElement('option'); o.value = opt; o.textContent = opt; if(opt === status) o.selected = true; sel.appendChild(o); });
      sel.addEventListener('change', () => updateStatus(t._key, sel.value));
      tdStatus.appendChild(sel);
    } else {
      tdStatus.textContent = status;
    }
    const tdActions = document.createElement('td');
    const delBtn = document.createElement('button'); delBtn.textContent = 'Excluir'; delBtn.addEventListener('click', () => deleteTransaction(t._key));
    tdActions.appendChild(delBtn);

    tr.appendChild(tdDesc); tr.appendChild(tdVal); tr.appendChild(tdType); tr.appendChild(tdCat); tr.appendChild(tdDate); tr.appendChild(tdStatus); tr.appendChild(tdActions);
    transactionsTable.appendChild(tr);
  });
}

function updateStatus(key, value){
  if(!key) return;
  if(useFirebase && db){
    db.ref(`transactions/${key}`).update({ status: value });
  } else {
    const idx = transactions.findIndex(t => t._key === key);
    if(idx >= 0){ transactions[idx].status = value; try{ localStorage.setItem('transactions_backup', JSON.stringify(transactions)); }catch(e){} refreshAll(); }
  }
}

function addTransaction(){
  const d = document.getElementById('description').value.trim();
  const a = document.getElementById('amount').value;
  const t = document.getElementById('type').value;
  const c = document.getElementById('category').value;
  const dt = document.getElementById('date').value;
  if(!d || !a || !dt) return alert('Preencha todos os campos!');
  const transaction = { description: d, amount: Number(parseFloat(a).toFixed(2)), type: t, category: c, date: dt, status: null };
  saveTransaction(transaction);
  // limpa campos
  document.getElementById('description').value = '';
  document.getElementById('amount').value = '';
  document.getElementById('date').value = '';
}

function deleteTransaction(key){
  if(!key) return;
  if(useFirebase && db){
    db.ref(`transactions/${key}`).remove();
  } else {
    transactions = transactions.filter(t => t._key !== key);
    try{ localStorage.setItem('transactions_backup', JSON.stringify(transactions)); }catch(e){}
    refreshAll();
  }
}

function exportCSV(){
  let csv = 'Descrição,Valor,Tipo,Categoria,Data,Status\n';
  transactions.forEach(t => {
    const line = [
      `"${(t.description||'').replace(/"/g,'""')}")` ,
      (t.amount||0),
      t.type,
      t.category || '',
      formatDateBR(t.date),
      getStatus(t)
    ];
    // garantir CSV válido
    csv += `${"\"" + (t.description||'').replace(/"/g,'""') + "\""},${t.amount},${t.type},${t.category||''},${formatDateBR(t.date)},${getStatus(t)}\n`;
  });
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'transacoes.csv'; a.click();
}

function applyFilters(){
  const start = document.getElementById('filter-start').value;
  const end = document.getElementById('filter-end').value;
  const type = document.getElementById('filter-type').value;
  const cat = document.getElementById('filter-category').value;
  let filtered = transactions.slice();
  if(start) filtered = filtered.filter(t => t.date >= start);
  if(end) filtered = filtered.filter(t => t.date <= end);
  if(type !== 'all') filtered = filtered.filter(t => t.type === type);
  if(cat  !== 'all') filtered = filtered.filter(t => t.category === cat);
  renderTable(filtered);
  // atualizar gráficos também quando filtrado
  if(chartsContainer.style.display !== 'none'){
    updateCharts(filtered);
    updateMonthlyChart(filtered);
  }
}

function updateCharts(data = transactions){
  const income = data.filter(t => t.type==='income').reduce((a, t) => a + Number(t.amount || 0), 0);
  const expense = data.filter(t => t.type==='expense').reduce((a, t) => a + Number(t.amount || 0), 0);
  const ctx = document.getElementById('chart').getContext('2d');
  if(window.myChart) window.myChart.destroy();
  window.myChart = new Chart(ctx, {
    type: 'doughnut',
    data: { labels:['Receitas','Despesas'], datasets:[{ data:[income,expense], backgroundColor:['#2ecc71','#e74c3c'] }] },
    options: {
      responsive: true,
      plugins: { legend:{position:'bottom'}, datalabels:{ color:'#fff', formatter:(v,ctx) => `${formatCurrency(v)}\n(${((v/(income+expense))*100 || 0).toFixed(1)}%)` } },
      cutout: '40%'
    }
  });

  const statusData = { Pago:0,Pendente:0,Atrasado:0 };
  const statusValue = { Pago:0,Pendente:0,Atrasado:0 };
  data.forEach(t => { const s = getStatus(t); if(!(s in statusData)) statusData[s]=0; statusData[s]++; statusValue[s] = (statusValue[s]||0) + Number(t.amount||0); });
  const ctx2 = document.getElementById('status-chart').getContext('2d');
  if(window.statusChart) window.statusChart.destroy();
  window.statusChart = new Chart(ctx2, {
    type:'doughnut',
    data:{ labels:Object.keys(statusData), datasets:[{ data:Object.values(statusData), backgroundColor:['#27ae60','#f39c12','#e74c3c'] }] },
    options:{
      responsive:true,
      plugins:{ legend:{position:'bottom'}, datalabels:{ color:'#fff', formatter:(v,ctx) => {
        const label = ctx.chart.data.labels[ctx.dataIndex];
        return `${label}\n${v} item(s)\n${formatCurrency(statusValue[label]||0)}`;
      } } },
      cutout:'40%'
    }
  });

  const categories = ['salario','alimentacao','transporte','lazer','outros'];
  const catValues = categories.map(cat => data.filter(t => t.category === cat && t.type === 'expense').reduce((a,t) => a+Number(t.amount||0), 0));
  const ctx3 = document.getElementById('category-chart').getContext('2d');
  if(window.categoryChart) window.categoryChart.destroy();
  window.categoryChart = new Chart(ctx3, {
    type:'bar',
    data:{
      labels:['Salário','Alimentação','Transporte','Lazer','Outros'],
      datasets:[{ label:'Despesas por Categoria', data:catValues, backgroundColor:['#1abc9c','#3498db','#9b59b6','#e67e22','#e74c3c'] }]
    },
    options:{
      responsive:true,
      plugins:{ legend:{display:false}, datalabels:{ color:'#000', anchor:'end', align:'top', formatter:v => `${formatCurrency(v)}\n(${((v/(catValues.reduce((a,b)=>a+b,0))*100||0).toFixed(1))}%)` } },
      scales:{ y:{ beginAtZero:true, ticks:{ callback: value => formatCurrency(value) } } }
    }
  });
}

function updateMonthlyChart(data = transactions){
  const months=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  const incomeMonthly=Array(12).fill(0);
  const expenseMonthly=Array(12).fill(0);
  data.forEach(t => { const d = new Date(t.date); if(isNaN(d)) return; const m = d.getMonth(); if(t.type==='income') incomeMonthly[m]+=Number(t.amount||0); else expenseMonthly[m]+=Number(t.amount||0); });
  const ctx = document.getElementById('monthly-chart').getContext('2d');
  if(window.monthlyChart) window.monthlyChart.destroy();
  window.monthlyChart = new Chart(ctx, {
    type:'line',
    data:{
      labels:months,
      datasets:[
        { label:'Receitas', data:incomeMonthly, borderColor:'#2ecc71', backgroundColor:'rgba(46,204,113,0.2)', fill:true, tension:0.3 },
        { label:'Despesas', data:expenseMonthly, borderColor:'#e74c3c', backgroundColor:'rgba(231,76,60,0.2)', fill:true, tension:0.3 }
      ]
    },
    options:{
      responsive:true,
      plugins:{ legend:{position:'bottom'}, datalabels:{ color:'#000', anchor:'end', align:'top', formatter: v => formatCurrency(v) } },
      scales:{ y:{ beginAtZero:true, ticks:{ callback: value => formatCurrency(value) } } }
    }
  });
}

function refreshAll(){
  renderTable();
  updateDashboard();
  if(chartsContainer.style.display !== 'none') updateCharts();
  updateMonthlyChart();
}

// Eventos UI
toggleChartsBtn.addEventListener('click', () => {
  if(chartsContainer.style.display==='none'){
    chartsContainer.style.display='flex';
    toggleChartsBtn.textContent = 'Ocultar Gráficos';
    updateCharts();
    updateMonthlyChart();
  } else {
    chartsContainer.style.display='none';
    toggleChartsBtn.textContent = 'Mostrar Gráficos';
  }
});

addTransactionBtn.addEventListener('click', addTransaction);
exportBtn.addEventListener('click', exportCSV);
document.getElementById('apply-filters').addEventListener('click', applyFilters);

// inicializa
loadTransactions();
</script>
</body>
</html>
